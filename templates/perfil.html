{% extends 'base.html' %}
{% block title %}Mi Perfil | Cortes Con Historia{% endblock %}

{% block extra_head %}
<style>
.perfil-card {
    transition: all 0.3s ease;
    border: 1px solid #e0e0e0;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.actividad-card {
    transition: all 0.3s ease;
    border: 1px solid #e0e0e0;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.turno-item {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 8px;
    border-left: 4px solid #ffd700;
    transition: all 0.3s ease;
}

.turno-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.btn-cancelar {
    background-color: #dc3545;
    border-color: #dc3545;
    color: white;
    border-radius: 20px;
    padding: 0.4rem 1rem;
    font-size: 0.85rem;
    transition: all 0.3s ease;
}

.btn-cancelar:hover {
    background-color: #c82333;
    border-color: #bd2130;
    transform: scale(1.05);
}

.btn-cancelar:disabled {
    background-color: #6c757d;
    border-color: #6c757d;
    cursor: not-allowed;
    transform: none;
}

.icono-turno {
    font-size: 2rem;
    color: #000 !important;
    margin-bottom: 0.5rem;
}

/* Forzar iconos negros en la bandeja de actividad */
.actividad-card .fas.fa-calendar-alt,
.actividad-card .fas.fa-calendar-check {
    color: #000 !important;
}

.sin-turnos {
    text-align: center;
    padding: 2rem;
    color: #6c757d;
}

.sin-turnos i {
    font-size: 4rem;
    margin-bottom: 1rem;
}

.section-divider {
    border: none;
    height: 2px;
    background: linear-gradient(90deg, transparent, #ffd700, transparent);
    margin: 2rem 0;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .container {
        padding-left: 10px;
        padding-right: 10px;
    }
    
    .turno-item {
        padding: 1rem !important;
    }
    
    .perfil-card .row .col-md-3 {
        text-align: center;
        margin-bottom: 1rem;
    }
    
    .btn-cancelar {
        font-size: 0.8rem;
        padding: 0.3rem 0.8rem;
    }
}

@media (max-width: 576px) {
    .d-flex.flex-wrap.gap-2 {
        flex-direction: column;
    }
    
    .d-flex.flex-wrap.gap-2 .btn {
        margin-bottom: 0.5rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2 class="mb-4 text-center">
        <i class="fas fa-user-circle me-2"></i>Mi Perfil
    </h2>
    
    <!-- Alerta de Usuario Deshabilitado -->
    {% if not user.estado %}
    <div class="alert alert-danger d-flex align-items-center mb-4" role="alert">
        <i class="fas fa-exclamation-triangle fa-2x me-3"></i>
        <div>
            <h5 class="alert-heading mb-2">
                <i class="fas fa-ban me-1"></i>Usuario Deshabilitado
            </h5>
            <p class="mb-2">
                <strong>Tu usuario está deshabilitado debido a que has acumulado 3 faltas por cancelaciones tardías.</strong>
            </p>
            <p class="mb-2">
                No puedes agendar turnos online hasta que tu cuenta sea reactivada.
            </p>
            <hr>
            <p class="mb-2">
                <i class="fas fa-info-circle me-1"></i>
                <strong>Para reactivar tu cuenta, comunícate con la barbería presencialmente o via 
                <a href="https://wa.me/123456789" target="_blank" class="text-decoration-underline" style="color: #0d6efd;">
                    <i class="fab fa-whatsapp me-1"></i>WhatsApp
                </a></strong>
            </p>
        </div>
    </div>
    {% endif %}
    
    <!-- Información del Perfil -->
    <div class="card perfil-card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-3 text-center mb-4">
                    <img src="{{ user.get_foto_perfil_url }}" alt="Foto de perfil" 
                         class="rounded-circle img-fluid" 
                         style="width: 150px; height: 150px; object-fit: cover; border: 3px solid #ffd700;">
                    <p class="text-muted mt-2 small">Foto de perfil</p>
                </div>
                <div class="col-md-9">
                    <h4 class="mb-3">Información Personal</h4>
                    <div class="row">
                        <div class="col-sm-6">
                            <p><strong>Nombre:</strong> {{ user.nombre }} {{ user.apellido }}</p>
                            <p><strong>Email:</strong> {{ user.email }}</p>
                            <p><strong>Teléfono:</strong> {{ user.telefono }}</p>
                        </div>
                        <div class="col-sm-6">
                            <p><strong>Fecha de nacimiento:</strong> {{ user.fecha_nacimiento }}</p>
                            <p><strong>Fecha de registro:</strong> {{ user.fecha_registro|date:"d/m/Y" }}</p>
                        </div>
                    </div>
                    <div class="mt-4 d-flex flex-wrap gap-2">
                        <a href="{% url 'editar-perfil' %}" class="btn btn-warning">
                            <i class="fas fa-edit"></i> Editar datos
                        </a>
                        <a href="{% url 'cambiar-contrasena' %}" class="btn btn-info">
                            <i class="fas fa-key"></i> Cambiar contraseña
                        </a>
                        <a href="{% url 'logout' %}" class="btn btn-outline-danger">
                            <i class="fas fa-sign-out-alt"></i> Cerrar sesión
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Estadísticas del Usuario -->
            <div class="row mt-4">
                <div class="col-12">
                    <h5 class="mb-3">
                        <i class="fas fa-chart-bar me-2"></i>Mis Estadísticas
                    </h5>
                    <div class="row text-center">
                        <div class="col-6 col-sm-3 mb-3">
                            <div class="p-3 border rounded">
                                <h4 class="text-primary mb-1">{{ estadisticas.turnos_activos_count }}</h4>
                                <small class="text-muted">Turnos Activos</small>
                            </div>
                        </div>
                        <div class="col-6 col-sm-3 mb-3">
                            <div class="p-3 border rounded">
                                <h4 class="text-success mb-1">{{ estadisticas.turnos_completados }}</h4>
                                <small class="text-muted">Completados</small>
                            </div>
                        </div>
                        <div class="col-6 col-sm-3 mb-3">
                            <div class="p-3 border rounded">
                                <h4 class="text-danger mb-1">{{ estadisticas.turnos_cancelados }}</h4>
                                <small class="text-muted">Cancelados</small>
                            </div>
                        </div>
                        <div class="col-6 col-sm-3 mb-3">
                            <div class="p-3 border rounded">
                                <h4 class="text-info mb-1">{{ estadisticas.total_turnos }}</h4>
                                <small class="text-muted">Total Histórico</small>
                            </div>
                        </div>
                    </div>
                    {% if estadisticas.barbero_favorito != 'Ninguno' %}
                    <div class="text-center mt-2">
                        <small class="text-muted">
                            <i class="fas fa-star me-1"></i>
                            Tu barbero favorito es: <strong>{{ estadisticas.barbero_favorito }}</strong>
                        </small>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <hr class="section-divider">

    <!-- Bandeja de Actividad del Usuario -->
    <div class="card actividad-card">
        <div class="card-header text-center" style="background: linear-gradient(135deg, #ffd700 0%, #ffed4a 100%);">
            <i class="fas fa-calendar-check" style="font-size: 2rem; color: #000 !important; margin-bottom: 0.5rem;"></i>
            <h4 class="mb-0" style="color: #000 !important;">Mi Bandeja de Actividad</h4>
            <p class="mb-0" style="color: #222;">Turnos reservados y próximos</p>
        </div>
        <div class="card-body">
            {% if turnos_activos %}
                <div class="row">
                    {% for turno in turnos_activos %}
                    <div class="col-12 col-lg-6 col-xl-4 mb-3">
                        <div class="turno-item p-3" data-turno-id="{{ turno.id }}">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1" style="color: #000 !important;">
                                        <i class="fas fa-calendar-alt me-1" style="color: #000 !important;"></i>
                                        {{ turno.fecha_hora|date:"l, d \d\e F \d\e Y" }}
                                    </h6>
                                    <h5 class="mb-1 fw-bold">
                                        <i class="fas fa-clock me-1"></i>
                                        {{ turno.fecha_hora|date:"H:i" }} hs
                                    </h5>
                                    <small class="text-muted">
                                        <i class="fas fa-hourglass-half me-1"></i>
                                        {% now "Y-m-d H:i:s" as now_time %}
                                        {% if turno.fecha_hora|timeuntil %}
                                            En {{ turno.fecha_hora|timeuntil }}
                                        {% endif %}
                                    </small>
                                </div>
                                <span class="badge bg-success">Reservado</span>
                            </div>
                            
                            <div class="mb-2">
                                <p class="mb-1">
                                    <i class="fas fa-user-tie me-2 text-primary"></i>
                                    <strong>Barbero:</strong> {{ turno.barbero.nombre }}
                                </p>
                                <p class="mb-1">
                                    <i class="fas fa-cut me-2 text-primary"></i>
                                    <strong>Servicio:</strong> {{ turno.servicio.nombre }}
                                </p>
                                <p class="mb-1">
                                    <i class="fas fa-dollar-sign me-2 text-success"></i>
                                    <strong>Precio:</strong> ${{ turno.servicio.precio }}
                                </p>
                            </div>
                            
                            <div class="text-center mt-3">
                                <button class="btn btn-cancelar btn-sm" 
                                        onclick="cancelarTurno({{ turno.id }}, '{{ turno.fecha_hora|date:"d/m/Y H:i" }}')"
                                        title="Cancelar este turno">
                                    <i class="fas fa-times me-1"></i>Cancelar Turno
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <div class="mt-3 d-flex justify-content-between align-items-center">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Puedes cancelar tus turnos hasta el día de la cita.
                    </small>
                    <a href="{% url 'reservar-turno-form' %}" class="btn btn-warning btn-sm">
                        <i class="fas fa-plus me-1"></i>Reservar Otro Turno
                    </a>
                </div>
                
            {% else %}
                <div class="sin-turnos">
                    <i class="fas fa-calendar-times text-muted"></i>
                    <h5 class="mt-3">No tienes turnos reservados</h5>
                    <p class="mb-3">¡Reserva tu próximo turno para que aparezca aquí!</p>
                    <a href="{% url 'reservar-turno-form' %}" class="btn btn-warning">
                        <i class="fas fa-calendar-plus me-2"></i>Reservar Turno
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal de Confirmación -->
<div class="modal fade" id="modalConfirmarCancelacion" tabindex="-1" aria-labelledby="modalConfirmarCancelacionLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalConfirmarCancelacionLabel">
                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                    Confirmar Cancelación
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="modalMensajeNormal">¿Estás seguro de que deseas cancelar el turno para el <strong id="fechaTurnoCancelar"></strong>?</p>
                <div class="alert alert-warning" id="modalAlertaNormal">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Nota:</strong> Una vez cancelado, el turno quedará disponible para otros usuarios y se notificará al administrador.
                </div>
                
                <!-- Alerta de cancelación tardía -->
                <div class="alert alert-danger d-none" id="modalAlertaFalta">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>⚠️ CANCELACIÓN TARDÍA</strong>
                    <p class="mb-2" id="modalMensajeFalta"></p>
                    <p class="mb-1"><strong>Faltas actuales:</strong> <span id="modalFaltasActuales">0</span>/3</p>
                    <p class="mb-0"><small>Si acumulas 3 faltas, tu usuario será deshabilitado automáticamente.</small></p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>No, mantener turno
                </button>
                <button type="button" class="btn btn-danger" id="btnConfirmarCancelacion">
                    <i class="fas fa-check me-1"></i><span id="btnTexto">Sí, cancelar turno</span>
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let turnoACancelar = null;
let esCancelacionConFalta = false;
let procesando = false; // Bandera para evitar múltiples envíos

function cancelarTurno(turnoId, fechaHora) {
    if (procesando) return; // Evitar múltiples aperturas durante procesamiento
    
    turnoACancelar = turnoId;
    esCancelacionConFalta = false;
    
    document.getElementById('fechaTurnoCancelar').textContent = fechaHora;
    
    // Resetear modal a estado normal
    document.getElementById('modalMensajeNormal').classList.remove('d-none');
    document.getElementById('modalAlertaNormal').classList.remove('d-none');
    document.getElementById('modalAlertaFalta').classList.add('d-none');
    
    // Resetear botón
    const botonConfirmar = document.getElementById('btnConfirmarCancelacion');
    botonConfirmar.disabled = false;
    botonConfirmar.innerHTML = '<i class="fas fa-check me-1"></i>Sí, cancelar turno';
    
    const modal = new bootstrap.Modal(document.getElementById('modalConfirmarCancelacion'));
    modal.show();
}

document.getElementById('btnConfirmarCancelacion').addEventListener('click', function() {
    if (!turnoACancelar || procesando) return;
    
    // Marcar como procesando
    procesando = true;
    
    // Obtener referencia al botón
    const botonConfirmar = this;
    
    // Deshabilitar el botón para evitar múltiples clicks
    botonConfirmar.disabled = true;
    botonConfirmar.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Procesando...';
    
    let formData = new FormData();
    if (esCancelacionConFalta) {
        formData.append('confirmar_con_falta', 'true');
    }
    
    fetch(`/usuarios/perfil/cancelar-turno/${turnoACancelar}/`, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Respuesta del servidor:', data); // Para debug
        
        if (data.warning && !esCancelacionConFalta) {
            // Mostrar advertencia de cancelación tardía
            document.getElementById('modalMensajeNormal').classList.add('d-none');
            document.getElementById('modalAlertaNormal').classList.add('d-none');
            document.getElementById('modalAlertaFalta').classList.remove('d-none');
            document.getElementById('modalMensajeFalta').textContent = data.mensaje;
            document.getElementById('modalFaltasActuales').textContent = data.faltas_actuales;
            
            esCancelacionConFalta = true;
            procesando = false; // Permitir segunda confirmación
            
            // Restablecer botón para segunda confirmación
            botonConfirmar.disabled = false;
            botonConfirmar.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>Sí, cancelar con falta';
            
            return; // Salir aquí, no continuar procesando
            
        } else if (data.success) {
            // Cancelación exitosa
            procesando = false; // Resetear procesamiento
            
            // Cerrar modal
            const modalInstance = bootstrap.Modal.getInstance(document.getElementById('modalConfirmarCancelacion'));
            if (modalInstance) {
                modalInstance.hide();
            }
            
            // Determinar tipo de alerta
            let alertClass = 'alert-success';
            let alertIcon = 'fas fa-check-circle';
            
            if (data.faltas !== undefined) {
                if (data.usuario_deshabilitado) {
                    alertClass = 'alert-danger';
                    alertIcon = 'fas fa-ban';
                } else {
                    alertClass = 'alert-warning';
                    alertIcon = 'fas fa-exclamation-triangle';
                }
            }
            
            // Mostrar mensaje
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${alertClass} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                <i class="${alertIcon} me-2"></i>
                ${data.mensaje}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // Insertar al inicio del contenedor
            const container = document.querySelector('.container');
            container.insertBefore(alertDiv, container.firstChild);
            
            // Ocultar el turno cancelado con animación
            const turnoElement = document.querySelector(`[data-turno-id="${turnoACancelar}"]`);
            if (turnoElement) {
                const turnoCard = turnoElement.closest('.col-12');
                if (turnoCard) {
                    turnoCard.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
                    turnoCard.style.opacity = '0';
                    turnoCard.style.transform = 'translateX(-20px)';
                    
                    setTimeout(() => {
                        turnoCard.remove();
                        
                        // Si el usuario fue deshabilitado, recargar la página
                        if (data.usuario_deshabilitado) {
                            setTimeout(() => location.reload(), 2000);
                        } else {
                            // Si no quedan turnos, recargar la página para mostrar el mensaje "sin turnos"
                            const turnosRestantes = document.querySelectorAll('[data-turno-id]').length;
                            if (turnosRestantes <= 1) {
                                setTimeout(() => location.reload(), 1500);
                            }
                        }
                    }, 500);
                }
            }
            
            // Resetear variables
            turnoACancelar = null;
            esCancelacionConFalta = false;
            
        } else {
            // Error en la respuesta - resetear procesamiento
            procesando = false;
            
            const modalInstance = bootstrap.Modal.getInstance(document.getElementById('modalConfirmarCancelacion'));
            if (modalInstance) {
                modalInstance.hide();
            }
            
            // Mostrar mensaje de error
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show';
            alertDiv.innerHTML = `
                <i class="fas fa-exclamation-circle me-2"></i>
                ${data.error || 'Error al cancelar el turno'}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            const container = document.querySelector('.container');
            container.insertBefore(alertDiv, container.firstChild);
            
            // Resetear variables
            turnoACancelar = null;
            esCancelacionConFalta = false;
        }
    })
    .catch(error => {
        console.error('Error de conexión:', error);
        
        // Cerrar modal
        const modalInstance = bootstrap.Modal.getInstance(document.getElementById('modalConfirmarCancelacion'));
        if (modalInstance) {
            modalInstance.hide();
        }
        
        // Mostrar mensaje de error
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-danger alert-dismissible fade show';
        alertDiv.innerHTML = `
            <i class="fas fa-exclamation-circle me-2"></i>
            Error de conexión al cancelar el turno. Por favor, intenta nuevamente.
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        const container = document.querySelector('.container');
        container.insertBefore(alertDiv, container.firstChild);
        
        // Resetear variables
        turnoACancelar = null;
        esCancelacionConFalta = false;
        procesando = false;
        
        // Restablecer botón
        botonConfirmar.disabled = false;
        botonConfirmar.innerHTML = '<i class="fas fa-check me-1"></i>Sí, cancelar turno';
    });
});

// Resetear variables cuando el modal se cierra
document.getElementById('modalConfirmarCancelacion').addEventListener('hidden.bs.modal', function() {
    if (!procesando) {
        turnoACancelar = null;
        esCancelacionConFalta = false;
        
        // Resetear botón
        const botonConfirmar = document.getElementById('btnConfirmarCancelacion');
        botonConfirmar.disabled = false;
        botonConfirmar.innerHTML = '<i class="fas fa-check me-1"></i>Sí, cancelar turno';
    }
});

// Obtener CSRF token
document.addEventListener('DOMContentLoaded', function() {
    if (!document.querySelector('[name=csrfmiddlewaretoken]')) {
        const csrfToken = '{{ csrf_token }}';
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'csrfmiddlewaretoken';
        input.value = csrfToken;
        document.body.appendChild(input);
    }
});
</script>
{% endblock %}
