{% extends 'base.html' %}
{% block title %}Cambiar Contraseña | Cortes Con Historia{% endblock %}

{% block extra_head %}
<style>
.contrasena-form {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 15px;
    padding: 2rem;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.form-section {
    background: white;
    border-radius: 10px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.form-section h5 {
    color: #333;
    border-bottom: 2px solid #ffd700;
    padding-bottom: 0.5rem;
    margin-bottom: 1rem;
}

.password-requirements {
    background-color: #e3f2fd;
    border-left: 4px solid #2196f3;
    padding: 1rem;
    border-radius: 5px;
    margin-bottom: 1rem;
}

.password-requirements ul {
    margin-bottom: 0;
    padding-left: 1.2rem;
}

.password-requirements li {
    margin-bottom: 0.3rem;
    color: #1976d2;
}

.password-strength {
    margin-top: 0.5rem;
    padding: 0.5rem;
    border-radius: 5px;
    display: none;
}

.strength-weak {
    background-color: #ffebee;
    border-left: 4px solid #f44336;
    color: #c62828;
}

.strength-medium {
    background-color: #fff3e0;
    border-left: 4px solid #ff9800;
    color: #ef6c00;
}

.strength-strong {
    background-color: #e8f5e8;
    border-left: 4px solid #4caf50;
    color: #2e7d32;
}

.security-tips {
    background-color: #fff8e1;
    border-left: 4px solid #ffc107;
    padding: 1rem;
    border-radius: 5px;
    margin-top: 1rem;
}

.password-toggle {
    position: relative;
}

.password-toggle input {
    padding-right: 40px;
}

.password-toggle .toggle-icon {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    cursor: pointer;
    color: #666;
    z-index: 10;
    user-select: none;
}

.password-toggle .toggle-icon:hover {
    color: #ffd700;
}

.recommendation-alert {
    background-color: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 5px;
    padding: 1rem;
    margin-top: 1rem;
    display: none;
}

.recommendation-alert.show {
    display: block;
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-key"></i> Cambiar Contraseña</h1>
        <a href="{% url 'perfil_usuario' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Volver al Perfil
        </a>
    </div>

    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="contrasena-form">
                <!-- Información de seguridad -->
                <div class="form-section">
                    <h5><i class="fas fa-shield-alt"></i> Seguridad de tu Cuenta</h5>
                    <div class="password-requirements">
                        <strong><i class="fas fa-info-circle"></i> Recomendaciones para una contraseña segura:</strong>
                        <ul class="mt-2">
                            <li>Mínimo 8 caracteres (obligatorio: al menos 4)</li>
                            <li>Al menos una letra mayúscula (A-Z)</li>
                            <li>Al menos una letra minúscula (a-z)</li>
                            <li>Al menos un número (0-9)</li>
                            <li>Puede incluir símbolos (!@#$%^&*)</li>
                        </ul>
                        <small class="text-muted mt-2 d-block">
                            <i class="fas fa-exclamation-triangle"></i> 
                            Estas son recomendaciones para mayor seguridad, pero puedes continuar aunque no las cumplas todas.
                        </small>
                    </div>
                </div>

                <!-- Formulario -->
                <form method="post" id="cambiar-contrasena-form">
                    {% csrf_token %}
                    
                    <!-- Contraseña actual -->
                    <div class="form-section">
                        <h5><i class="fas fa-unlock-alt"></i> Verificación Actual</h5>
                        <div class="mb-3">
                            <label for="{{ form.contrasena_actual.id_for_label }}" class="form-label">
                                {{ form.contrasena_actual.label }}
                            </label>
                            <div class="password-toggle">
                                {{ form.contrasena_actual }}
                                <i class="fas fa-eye toggle-icon" onclick="togglePassword('{{ form.contrasena_actual.id_for_label }}')" id="toggle-{{ form.contrasena_actual.id_for_label }}"></i>
                            </div>
                            {% if form.contrasena_actual.errors %}
                                <div class="text-danger mt-1">
                                    <i class="fas fa-exclamation-circle"></i>
                                    {% for error in form.contrasena_actual.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <small class="form-text text-muted">{{ form.contrasena_actual.help_text }}</small>
                        </div>
                    </div>

                    <!-- Nueva contraseña -->
                    <div class="form-section">
                        <h5><i class="fas fa-lock"></i> Nueva Contraseña</h5>
                        <div class="mb-3">
                            <label for="{{ form.nueva_contrasena.id_for_label }}" class="form-label">
                                {{ form.nueva_contrasena.label }}
                            </label>
                            <div class="password-toggle">
                                {{ form.nueva_contrasena }}
                                <i class="fas fa-eye toggle-icon" onclick="togglePassword('{{ form.nueva_contrasena.id_for_label }}')" id="toggle-{{ form.nueva_contrasena.id_for_label }}"></i>
                            </div>
                            {% if form.nueva_contrasena.errors %}
                                <div class="text-danger mt-1">
                                    <i class="fas fa-exclamation-circle"></i>
                                    {% for error in form.nueva_contrasena.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            
                            <!-- Indicador de fuerza de contraseña -->
                            <div id="password-strength" class="password-strength">
                                <span id="strength-text"></span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.confirmar_contrasena.id_for_label }}" class="form-label">
                                {{ form.confirmar_contrasena.label }}
                            </label>
                            <div class="password-toggle">
                                {{ form.confirmar_contrasena }}
                                <i class="fas fa-eye toggle-icon" onclick="togglePassword('{{ form.confirmar_contrasena.id_for_label }}')" id="toggle-{{ form.confirmar_contrasena.id_for_label }}"></i>
                            </div>
                            {% if form.confirmar_contrasena.errors %}
                                <div class="text-danger mt-1">
                                    <i class="fas fa-exclamation-circle"></i>
                                    {% for error in form.confirmar_contrasena.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <small class="form-text text-muted">{{ form.confirmar_contrasena.help_text }}</small>
                        </div>
                    </div>

                    <!-- Consejos de seguridad -->
                    <div class="security-tips">
                        <strong><i class="fas fa-lightbulb"></i> Consejos de seguridad:</strong>
                        <ul class="mt-2 mb-0">
                            <li>No uses información personal obvia (nombre, fecha de nacimiento)</li>
                            <li>No reutilices contraseñas de otras cuentas</li>
                            <li>Considera usar un gestor de contraseñas</li>
                            <li>Cambia tu contraseña regularmente</li>
                        </ul>
                    </div>

                    <!-- Alerta de recomendaciones no cumplidas -->
                    <div id="recommendation-alert" class="recommendation-alert">
                        <h6><i class="fas fa-exclamation-triangle text-warning"></i> Advertencia de Seguridad</h6>
                        <p id="recommendation-message">Tu contraseña no cumple algunas recomendaciones de seguridad.</p>
                        <p class="mb-0"><strong>¿Estás seguro de que deseas continuar?</strong></p>
                    </div>

                    <!-- Botones -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="{% url 'perfil_usuario' %}" class="btn btn-secondary btn-lg">
                            <i class="fas fa-times"></i> Cancelar
                        </a>
                        <button type="submit" class="btn btn-success btn-lg" id="submit-btn">
                            <i class="fas fa-save"></i> Cambiar Contraseña
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Función para mostrar/ocultar contraseñas
function togglePassword(fieldId) {
    const field = document.getElementById(fieldId);
    const icon = document.getElementById(`toggle-${fieldId}`);
    
    if (field.type === 'password') {
        field.type = 'text';
        icon.className = 'fas fa-eye-slash toggle-icon';
    } else {
        field.type = 'password';
        icon.className = 'fas fa-eye toggle-icon';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const nuevaContrasena = document.getElementById('{{ form.nueva_contrasena.id_for_label }}');
    const confirmarContrasena = document.getElementById('{{ form.confirmar_contrasena.id_for_label }}');
    const strengthIndicator = document.getElementById('password-strength');
    const strengthText = document.getElementById('strength-text');
    const submitBtn = document.getElementById('submit-btn');
    const recommendationAlert = document.getElementById('recommendation-alert');
    const recommendationMessage = document.getElementById('recommendation-message');

    function checkPasswordStrength(password) {
        let strength = 0;
        let requirements = {
            length: password.length >= 8,
            lowercase: /[a-z]/.test(password),
            uppercase: /[A-Z]/.test(password),
            number: /\d/.test(password),
            special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
        };

        // Contar requisitos cumplidos
        Object.values(requirements).forEach(req => {
            if (req) strength++;
        });

        return { strength, requirements };
    }

    function updatePasswordStrength() {
        const password = nuevaContrasena.value;
        if (password.length === 0) {
            strengthIndicator.style.display = 'none';
            recommendationAlert.classList.remove('show');
            return;
        }

        const result = checkPasswordStrength(password);
        strengthIndicator.style.display = 'block';
        
        // Remover clases anteriores
        strengthIndicator.className = 'password-strength';
        
        if (result.strength <= 2) {
            strengthIndicator.classList.add('strength-weak');
            strengthText.innerHTML = '<i class="fas fa-times-circle"></i> Contraseña débil';
        } else if (result.strength <= 4) {
            strengthIndicator.classList.add('strength-medium');
            strengthText.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Contraseña media';
        } else {
            strengthIndicator.classList.add('strength-strong');
            strengthText.innerHTML = '<i class="fas fa-check-circle"></i> Contraseña fuerte';
        }

        // Mostrar recomendaciones faltantes
        let missing = [];
        if (!result.requirements.length) missing.push('al menos 8 caracteres');
        if (!result.requirements.lowercase) missing.push('letra minúscula');
        if (!result.requirements.uppercase) missing.push('letra mayúscula');
        if (!result.requirements.number) missing.push('número');

        if (missing.length > 0) {
            strengthText.innerHTML += '<br><small>Recomendaciones faltantes: ' + missing.join(', ') + '</small>';
            
            // Mostrar alerta de recomendaciones si la contraseña no es fuerte
            if (result.strength < 4) {
                recommendationMessage.innerHTML = `Tu contraseña no cumple las siguientes recomendaciones de seguridad: <strong>${missing.join(', ')}</strong>. Aunque puedes continuar, se recomienda mejorar la seguridad de tu contraseña.`;
                recommendationAlert.classList.add('show');
            } else {
                recommendationAlert.classList.remove('show');
            }
        } else {
            recommendationAlert.classList.remove('show');
        }
    }

    function validatePasswordMatch() {
        const password = nuevaContrasena.value;
        const confirmPassword = confirmarContrasena.value;
        
        if (confirmPassword.length > 0 && password !== confirmPassword) {
            confirmarContrasena.classList.add('is-invalid');
            // Mostrar mensaje de error
            let errorDiv = confirmarContrasena.parentNode.querySelector('.password-match-error');
            if (!errorDiv) {
                errorDiv = document.createElement('div');
                errorDiv.className = 'text-danger mt-1 password-match-error';
                confirmarContrasena.parentNode.appendChild(errorDiv);
            }
            errorDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i> Las contraseñas no coinciden';
        } else {
            confirmarContrasena.classList.remove('is-invalid');
            let errorDiv = confirmarContrasena.parentNode.querySelector('.password-match-error');
            if (errorDiv) {
                errorDiv.remove();
            }
        }
    }

    // Event listeners
    nuevaContrasena.addEventListener('input', updatePasswordStrength);
    confirmarContrasena.addEventListener('input', validatePasswordMatch);
    nuevaContrasena.addEventListener('input', validatePasswordMatch);

    // Validar formulario antes de enviar
    document.getElementById('cambiar-contrasena-form').addEventListener('submit', function(e) {
        const password = nuevaContrasena.value;
        const confirmPassword = confirmarContrasena.value;
        
        // Verificar que las contraseñas coincidan
        if (password !== confirmPassword) {
            e.preventDefault();
            alert('Las contraseñas no coinciden. Por favor, verifica e intenta de nuevo.');
            return false;
        }
        
        // Verificar longitud mínima obligatoria
        if (password.length < 4) {
            e.preventDefault();
            alert('La contraseña debe tener al menos 4 caracteres.');
            return false;
        }
        
        // Si la contraseña no cumple las recomendaciones, mostrar confirmación
        const result = checkPasswordStrength(password);
        if (result.strength < 4) {
            const missing = [];
            if (!result.requirements.length) missing.push('al menos 8 caracteres');
            if (!result.requirements.lowercase) missing.push('letra minúscula');
            if (!result.requirements.uppercase) missing.push('letra mayúscula');
            if (!result.requirements.number) missing.push('número');
            
            const message = `Tu contraseña no cumple las siguientes recomendaciones de seguridad: ${missing.join(', ')}.\n\n¿Estás seguro de que deseas continuar con una contraseña menos segura?`;
            
            if (!confirm(message)) {
                e.preventDefault();
                return false;
            }
        }
        
        return true;
    });
});
</script>
{% endblock %}
